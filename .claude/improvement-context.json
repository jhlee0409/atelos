{
  "projectName": "ATELOS LLM Control Improvement",
  "version": "1.6.0",
  "lastUpdated": "2025-11-27T06:00:00Z",
  "currentPhase": "P3",
  "currentTask": "P3-2",

  "modelConfig": {
    "targetModel": "gemini-2.5-flash-lite-preview-09-2025",
    "previousModel": "gemini-2.0-flash",
    "appliedSettings": {
      "temperature": 0.5,
      "temperatureEndGame": 0.6,
      "maxTokens": 2000,
      "maxTokensEndGame": 2500,
      "maxTokensUltraLite": 1200
    }
  },

  "phases": {
    "P1": {
      "name": "LLM Control Enhancement",
      "status": "completed",
      "completedAt": "2025-11-27T01:00:00Z",
      "summary": "Model changed to gemini-2.5-flash-lite, prompts enhanced with choice/stat/flag rules, validation strengthened"
    },
    "P2": {
      "name": "Admin Page Enhancement",
      "status": "completed",
      "completedAt": "2025-11-27T05:00:00Z",
      "tasks": [
        {
          "id": "P2-1",
          "name": "Add scenarioStats management UI",
          "status": "completed",
          "changes": [
            "Added stat CRUD functions (addStat, updateStat, removeStat, saveStat, editStat)",
            "Added stat management UI with edit/view modes",
            "Added validation for stat ID uniqueness and min/max range"
          ]
        },
        {
          "id": "P2-2",
          "name": "Add triggerCondition field to flags",
          "status": "completed",
          "changes": [
            "Added triggerCondition field to ScenarioFlag type in types/index.ts",
            "Enhanced flag UI with edit/view modes",
            "Added triggerCondition input field with placeholder examples",
            "Added flag type selector (boolean/count)"
          ]
        },
        {
          "id": "P2-3",
          "name": "Improve image upload (blob URL → base64)",
          "status": "completed",
          "changes": [
            "Added fileToBase64() utility function to lib/utils.ts",
            "Updated BaseContent.tsx to use base64 encoding for poster images",
            "Updated CharacterContent.tsx to use base64 encoding for character images",
            "Added upload progress state and error handling",
            "File size limits: 2MB for poster, 1MB for characters"
          ]
        },
        {
          "id": "P2-4",
          "name": "Unify SystemCondition types",
          "status": "completed",
          "changes": [
            "Added CONDITION_TYPE_MAP for Korean↔English type conversion",
            "Added COMPARISON_MAP for symbol↔English operator conversion",
            "Updated EndingConditionBuilder to store English values (required_stat, greater_equal)",
            "UI displays Korean/symbols but stores English values for type safety",
            "Added all comparison operators (>, <, !=) to UI"
          ]
        },
        {
          "id": "P2-5",
          "name": "Strengthen scenario validation",
          "status": "completed",
          "changes": [
            "Added VALIDATION_IDS for characters, stats, endings, relationships, flags",
            "Added validateCharacters(), validateStats(), validateEndings() functions",
            "Added validateRelationships(), validateFlags() functions",
            "Added validateScenarioFull() for comprehensive validation with warnings",
            "Added ValidationResult type with errors, warnings, details",
            "Added getValidationMessage() utility function"
          ]
        }
      ]
    },
    "P3": {
      "name": "Game Client Stabilization",
      "status": "in_progress",
      "tasks": [
        {
          "id": "P3-1",
          "name": "Improve action classification logic",
          "status": "completed",
          "changes": [
            "Added ActionCategory type with 11 categories (combat, diplomacy, etc.)",
            "Added regex patterns for each action category",
            "Added classifyAction() function with confidence scoring",
            "Added createPlayerAction() helper function",
            "Added compareActionTypes() for choice contrast validation",
            "Updated GameClient.tsx to use new classification system"
          ]
        },
        {"id": "P3-2", "name": "Apply HTML escaping (XSS prevention)", "status": "pending"},
        {"id": "P3-3", "name": "Add expected result hints to choices", "status": "pending"},
        {"id": "P3-4", "name": "Transparentize stat amplification", "status": "pending"}
      ]
    }
  },

  "fileChanges": {
    "lib/gemini-client.ts": {
      "status": "modified",
      "phase": "P1"
    },
    "lib/prompt-builder.ts": {
      "status": "modified",
      "phase": "P1"
    },
    "lib/game-ai-client.ts": {
      "status": "modified",
      "phase": "P3",
      "changes": [
        "P1: Added choice/stat validation functions",
        "P3-1: Added action classification system with regex patterns"
      ]
    },
    "app/game/[scenarioId]/GameClient.tsx": {
      "status": "modified",
      "phase": "P3",
      "changes": ["P3-1: Updated to use createPlayerAction() for action classification"]
    },
    "types/index.ts": {
      "status": "modified",
      "phase": "P2",
      "changes": ["Added triggerCondition field to ScenarioFlag type"]
    },
    "pages/admin/ScenarioEditor/SystemRulesContent.tsx": {
      "status": "modified",
      "phase": "P2",
      "changes": [
        "Added complete stat management UI",
        "Enhanced flag management UI with triggerCondition field"
      ]
    },
    "lib/utils.ts": {
      "status": "modified",
      "phase": "P2",
      "changes": ["Added fileToBase64(), isBase64DataUrl(), isBlobUrl() functions"]
    },
    "pages/admin/ScenarioEditor/BaseContent.tsx": {
      "status": "modified",
      "phase": "P2",
      "changes": ["Changed poster image upload from blob URL to base64"]
    },
    "pages/admin/ScenarioEditor/CharacterContent.tsx": {
      "status": "modified",
      "phase": "P2",
      "changes": ["Changed character image upload from blob URL to base64"]
    },
    "pages/admin/ScenarioEditor/CoreStoryElementsContent.tsx": {
      "status": "modified",
      "phase": "P2",
      "changes": [
        "Added type/comparison mapping system",
        "Unified SystemCondition values to English for type safety"
      ]
    },
    "lib/validations.ts": {
      "status": "modified",
      "phase": "P2",
      "changes": [
        "Added comprehensive validation functions for all scenario components",
        "Added validateScenarioFull() with warnings support"
      ]
    },
    "constants/scenario.ts": {
      "status": "modified",
      "phase": "P2",
      "changes": ["Added new VALIDATION_IDS and MIN_* constants"]
    }
  },

  "validationRules": {
    "choiceMinLength": 15,
    "choiceMaxLength": 80,
    "koreanRatio": 0.8,
    "maxSingleStatChange": 40,
    "validEndings": ["한다", "이다", "된다", "른다", "ㄴ다"]
  },

  "promptEnhancements": {
    "choiceRules": "Length 15-50 chars, ~한다/~이다 ending, contrast required",
    "statRules": "±5-10 normal, ±10-20 important, ±20-30 extreme, max ±40",
    "flagRules": "9 flags with specific trigger conditions defined"
  },

  "notes": [
    "Phase 1 completed - LLM control significantly improved",
    "Phase 2 completed - Admin page fully enhanced",
    "P3-1 completed - Action classification with 11 regex categories",
    "Next: P3-2 HTML escaping (XSS prevention)"
  ]
}
